- name: Create config dir
  file:
      path: "{{postgresql_data_path}}"
      state: directory
- name: Run postgresql docker
  docker_container:
      name: "psql-database"
      image: postgres
      state: started
      restart: yes
      restart_policy: "unless-stopped"
      volumes:
        - "{{ postgresql_data_path }}:/var/lib/postgresql/data"
      published_ports:
         "0.0.0.0:{{ postgresql_port }}:5432"
      env:
          POSTGRES_PASSWORD: "{{ postgresql_password }}"
- name: Postgresql config
  template:
      src: pg_hba.j2
      dest: /root/psql-data/pg_hba.conf
- name: Install python lib
  apt:
      pkg:
          - python-psycopg2
      state: present
      update_cache: true
- name: Wait for postgresql to be up
  shell: "if pg_isready -h localhost -p {{ postgresql_port }}; then echo it works; fi"
  register: result
  retries: 20
  delay: 10
  until: result.stdout.find("it works")
